define(["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/event"],function(a,b,c,d,e,f,g,h,i){var j={},k={},l=[],m=[],n=1,o="",p=function(a,b){return"undefined"!=typeof b&&b&&""!=b&&"moodle"!==b&&"core"!==b||(b="core"),b+"-"+a},q=function(b,c){var d,e=b.split(","),h="",i="",k="";e.length>0&&(h=e.shift().trim()),e.length>0&&(i=e.shift().trim()),e.length>0&&(k=e.join(",").trim());var l=p(h,i),m=s(g.theme,l);if(m===!0)return w(l,x);var n=f.imageUrl(h,i),q={attributes:[{name:"src",value:n},{name:"alt",value:c(k)},{name:"class",value:"smallicon"}]},r=j[o+"/core/pix_icon"];return d=a.render(r,q,x),d.trim()},r=function(a,b){if("undefined"!=typeof b.map[a]&&"undefined"!=typeof b.map[a].template)return b.map[a].template;if("undefined"!=typeof b.defaults&&"undefined"!=typeof b.defaults.template)return b.defaults.template;var c=new Error('core/templates: Template not defined for icon "'+a+'"');e.exception(c)},s=function(a,b){return t(b)===!1?!1:u(a,b)===!1?!1:!0},t=function(a){return null!==a.match(/^[a-zA-Z]+(_[a-zA-Z]+)*-(\w+\/)*\w+$/)},u=function(a,b){F(!1).done(function(a){return"undefined"!=typeof r(b,a)}).fail(e.exception)},v=function(a,c){var d={};return"undefined"!=typeof c.defaults&&"undefined"!=typeof c.defaults.data&&b.extend(d,c.defaults.data),"undefined"!=typeof c.map[a]&&"undefined"!=typeof c.map[a].data&&b.extend(d,c.map[a].data),d},w=function(c,d){var f=c.split(",").map(function(a){return a.trim()}),g=f[0],h={};"undefined"!=typeof f[1]&&(h=JSON.parse(f[1]));var i="";return F(!1).done(function(c){var f=r(g,c),j=b.extend(v(g,c),{customdata:h});E(f,!1).done(function(b){i=a.render(b,j,d)}).fail(e.exception)}).fail(e.exception),i.trim()},x=function(a){var b="";return E(a,!1).done(function(a){b=a}).fail(e.exception),b},y=function(a,b){return m.push(b(a,this)),""},z=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim()),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim()),""!==f&&(f=b(f,this)),0===f.indexOf("{")&&0!==f.indexOf("{{")&&(f=JSON.parse(f));var g=l.length;return l.push({key:d,component:e,param:f}),"{{_s"+g+"}}"},A=function(a,b){var c=b(a.trim(),this);return c=c.replace('"','\\"').replace(/([\{\}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>"),'"'+c+'"'},B=function(a,b){o=b,l=[],m=[],a.uniqid=n++,a.str=function(){return z},a.pix=function(){return q},a.flex_icon=function(){return w},a.js=function(){return y},a.quote=function(){return A},a.globals={config:g},a.currentTheme=b},C=function(a){var b="";m.length>0&&(b=m.join(";\n"));var c=0;for(c=0;c<a.length;c++)b=b.replace("{{_s"+c+"}}",a[c]);return b},D=function(c,e,f){var g=b.Deferred();o=f;var h=E("core/pix_icon",!0);return h.done(function(){B(e,f);var b="";try{b=a.render(c,e,x)}catch(h){g.reject(h)}l.length>0?d.get_strings(l).done(function(a){var c;for(c=0;c<a.length;c++)b=b.replace("{{_s"+c+"}}",a[c]);g.resolve(b.trim(),C(a))}).fail(function(a){g.reject(a)}):g.resolve(b.trim(),C([]))}).fail(function(a){g.reject(a)}),g.promise()},E=function(a,d){var e=b.Deferred(),f=a.split("/"),g=f.shift(),i=f.shift(),k=o+"/"+a;if(k in j)return e.resolve(j[k]),e.promise();var l=h.get("core_template/"+k);if(l)return e.resolve(l),j[k]=l,e.promise();var m=c.call([{methodname:"core_output_load_template",args:{component:g,template:i,themename:o}}],d,!1);return m[0].done(function(a){h.set("core_template/"+k,a),j[k]=a,e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},F=function(a){var d=b.Deferred(),e=o;if(e in k)return d.resolve(k[e]),d.promise();var f=JSON.parse(h.get("core_flex_icon/"+e));if(f)return d.resolve(f),k[e]=f,d.promise();var g=c.call([{methodname:"core_output_load_flex_icons_cache",args:{themename:o}}],a,!1);return g[0].done(function(a){h.set("core_flex_icon/"+e,JSON.stringify(a)),k[e]=a,d.resolve(a)}).fail(function(a){d.reject(a)}),d.promise()},G=function(a){if(""!==a.trim()){var c=b("<script>").attr("type","text/javascript").html(a);b("head").append(c)}},H=function(a,c,d,e){var f=b(a);if(f.length){var g=b(c);e?(f.empty(),f.append(g)):f.replaceWith(g),G(d),i.notifyFilterContentUpdated(g)}};return{render:function(a,c,d){var e=b.Deferred();"undefined"==typeof d&&(d=g.theme),o=d;var f=E(a,!0);return f.done(function(a){var b=D(a,c,d);b.done(function(a,b){e.resolve(a,b)}).fail(function(a){e.reject(a)})}).fail(function(a){e.reject(a)}),e.promise()},runTemplateJS:G,replaceNodeContents:function(a,b,c){return H(a,b,c,!0)},replaceNode:function(a,b,c){return H(a,b,c,!1)},replacePix:function(a,b,c,d){var e=b+","+c+","+d,f=q(e,function(a){return a});return H(a,f,"",!1)},renderFlexIcon:function(a,c,d){var e=this,f=b.Deferred();return F(!0).done(function(g){var h={};b.extend(h,g.defaults,g.map[a]),void 0===h.data?h.data={}:h.data.customdata={alt:c},void 0!==d&&""!==d&&(h.data.customdata.classes=d),e.render(h.template,h.data).done(function(a){f.resolve(a)})}),f.promise()}}});