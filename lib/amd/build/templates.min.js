define(["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/event","core/flex_icon","core/log","core/user_date"],function(a,b,c,d,e,f,g,h,i,j,k,l){String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return b=b||0,this.substr(b,a.length)===a});var m={},n={},o=function(c,f,h){var i=b.Deferred(),j=[],m=[],n=[],o="",q=[],r=[],t=!0,u=!0,v=function(a){var b="",c=p(a);return c.done(function(a){b=a}).fail(e.exception),""===b&&(n.push(c),t=!1),b},w=function(a,b){if(a.indexOf("{{")===-1||a.indexOf("}}")===-1)return a;if(a.match(/^\{{2,3}\s*([a-zA-Z0-9_]+)\s*\}{2,3}$/)){var c=a.replace(/^\{{2,3}\s*([a-zA-Z0-9_]+)\s*\}{2,3}$/,"$1");if(this.hasOwnProperty(c))return this[c]}return k.debug("Escaped content contains unexpected mustache processing queues. It will be lost."),""},x=function(a,b){var c=a.split(","),d=function(a,b,c,d){var e="",f=0,g=0;return void 0!==c&&""!==c&&(f=q.length,q.push({key:c,component:d}),e="[[_s"+f+"]]"),g=q.length,q.push({key:a,component:b,param:e}),"[[_s"+g+"]]"},e=function(a){var b=a.shift();return void 0===b&&(b=""),b.trim()},f=function(a){return 0===a.indexOf("{{")&&(a=b("{{#esc}}"+a+"{{/esc}}",this)),a},g=function(a){var b=e(a);return b=f(b)},h=function(a){var b=a[0].trim(),c=a[a.length-1].trim();return 0===b.search("{")||"}"===c.substr(c.length-1)},i=function(a,b,c){var d=c.join(",").trim(),e={};0===d.indexOf("{")&&0!==d.indexOf("{{")?(d=f(d),e=JSON.parse(d)):(e=f(d),0===e.indexOf("{")&&0!==e.indexOf("{{")&&(e=JSON.parse(e)));var g=q.length;return q.push({key:a,component:b,param:e}),"[[_s"+g+"]]"},j=g(c),l=g(c),m="",n="";return j.match(/^[a-zA-Z][a-zA-Z0-9\.:\/_\-]*$/)?(""===l?l="core":(!l.match(/^[a-z]+(_[a-z][a-z0-9_]*)?[a-z0-9]+$/)||l.search("__")>0)&&(k.debug("invalid component:"+l),l="core"),0===c.length?d(j,l):h(c)?(k.debug('Legacy string helper API in use for "'+a+'"'),i(j,l,c)):(m=g(c),n=g(c),m.match(/^[a-zA-Z][a-zA-Z0-9\.:\/_\-]*$/)||(k.debug('Invalid string identifier in "'+a+'"'),m=""),""===n?n="":(!n.match(/^[a-z]+(_[a-z][a-z0-9_]*)?[a-z0-9]+$/)||n.search("__")>0)&&(k.debug("Invalid component:"+n),n=""),d(j,l,m,n))):(k.debug('Invalid string identifier in "'+a+'"'),"")},y=function(a,b){var c=a.split(","),d=function(a,b,c){var d=m.length;return a=f(a),m.push(s(a,b,c)),"<_p"+d+">"},e=function(a){var b=a.shift();return void 0===b&&(b=""),b.trim()},f=function(a){return 0===a.indexOf("{{")&&(a=b("{{#esc}}"+a+"{{/esc}}",this)),a},g=function(a){var b=e(a);return b=f(b)},h=f(c.shift().trim()),i=function(a){if(0===a.length)return!1;var b=a[0].trim(),c=a[a.length-1].trim();return(0===b.search("{")||"}"===c.substr(c.length-1))&&((0!==b.search("{{")||"}}"!==c.substr(c.length-2))&&("{"===b[0]&&"}"===c[c.length-1]))},j=function(a,b){var c=b.join(",").trim(),e="",g="";if(""!==c){c.match(/^\{{2}.*?\}{2}$/)&&(c=f(c));try{c=JSON.parse(c)}catch(h){k.error("Unable to parse customdata for flex icon helper. Not valid JSON."),c={}}"undefined"!=typeof c.alt&&(e=f(c.alt)),c.classes&&(g=f(c.classes))}return d(a,e,g)},l="",n="",o="",p="";if(i(c))return k.debug('Legacy flex icon helper API in use for "'+a+'"'),j(h,c);if(l=g(c),""===l||l.match(/^[a-zA-Z][a-zA-Z0-9\.:\/_\-]*$/)||k.debug('Invalid alt identifier for flex icon "'+l+'", it must be a string identifier.'),n=g(c),""!==n&&(!n.match(/^[a-z]+(_[a-z][a-z0-9_]*)?[a-z0-9]+$/)||n.search("__")>0)&&k.debug('Invalid alt identifier for flex icon "'+n+'", it must be a component identifier.'),""!==l){var r=q.length;q.push({key:l,component:n}),o="[[_s"+r+"]]"}else o="";return p=e(c),d(h,o,p)},z=function(a,b){var c=a.split(","),d=function(a,b,c,d){var e=m.length;return""===b&&(b="core"),a=f(a),m.push(s(b+"|"+a,c,d)),"<_p"+e+">"},e=function(a){var b=a.shift();return void 0===b&&(b=""),b.trim()},f=function(a){return 0===a.indexOf("{{")&&(a=b("{{#esc}}"+a+"{{/esc}}",this)),a},g=function(a,b){var c=e(a);return c=f(c,b)},h=function(a){if(0===a.length)return!1;var b=a[0].trim(),c=a[a.length-1].trim();return(0===b.search("{")||"}"===c.substr(c.length-1))&&(0!==b.search("{{")||c.search("}}")===c.length-1)},i=function(a,b,c){var d,e;try{e=JSON.parse(c)}catch(g){e={alt:c}}for(d in e)e.hasOwnProperty(d)&&(e[d]=f(e[d]));return e},j="",l="",n="",o="",p="",r="",t="",u={};if(j=g(c),l=g(c),!c.length)return d(j,l);if(r=e(c),r.match(/^[a-zA-Z][a-zA-Z0-9\.:\/_\-]*$/)){n=r.trim(),o=e(c),""!==o&&(!o.match(/^[a-z]+(_[a-z][a-z0-9_]*)?[a-z0-9]+$/)||o.search("__")>0)&&k.debug("invalid component:"+o);var v=q.length;q.push({key:n,component:o}),p="[[_s"+v+"]]",t=e(c)}else k.debug('Legacy pix API in use for string:"'+a+'" - Please use the pix icon template or new API'),c.unshift(r),h(c)?(u=i(j,l,c.join(",")),u.hasOwnProperty("alt")&&(p=u.alt),u.hasOwnProperty("classes")&&(t=u.classes)):p=f(c.join(","));return"flexicon"===l?y.apply(this,[j+","+p,b]):d(j,l,p,t)},A=function(a,b){return j.push(b(a,this)),""},B=function(a,b){var c=b(a.trim(),this);return c=c.replace('"','\\"').replace(/([\{\}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>"),'"'+c+'"'},C=function(a,b){var c=/(.*?),(.*)/,d=a.match(c),e=b("{{#esc}}"+d[1].trim()+"{{/esc}}",this),f=b(d[2].trim(),this),g=r.length;return r.push({timestamp:parseInt(e,10),format:f}),"[[_t_"+g+"]]"};f.str=function(){return x},f.pix=function(){return z},f.flex_icon=function(){return y},f.js=function(){return A},f.quote=function(){return B},f.userdate=function(){return C},f.esc=function(){return w},f.globals={config:g};var D=b.Deferred(),E=function(){b.when.apply(b,n).done(function(){if(t&&!u)D.resolve();else{u=!1,j=[],m=[],n=[],o="",q=[],r=[],t=!0;try{o=a.render(c,f,v),E()}catch(b){i.reject(b)}}})};return E(),D.done(function(){for(var a=0;a<m.length;a++)m[a].done(function(a){return function(b,c){j.push(c),o=o.replace("<_p"+a+">",b)}}(a));b.when.apply(b,m).then(function(){var a=b.Deferred();return j=j.join(";\n"),q.length>0?d.get_strings(q).done(function(b){for(var c,d=0;(o.indexOf("[[_s")!==-1||j.indexOf("[[_s")!==-1)&&d<2;){for(c=0;c<b.length;c++){for(;o.indexOf("[[_s"+c+"]]")!==-1;)o=o.replace("[[_s"+c+"]]",b[c]);for(;j.indexOf("[[_s"+c+"]]")!==-1;)j=j.replace("[[_s"+c+"]]",b[c])}d++}r.length>0&&r.forEach(function(a){return a.format=a.format.replace(/\[\[_s\d+\]\]/,function(a){var c=parseInt(a.match(/\d+/),10);return b[c]}),a}),a.resolve()}):a.resolve(),a}).then(function(){return r.length>0?(k.debug("userdate mustache helper in use - This has a potential XSS security issue"),l.get(r).then(function(a){a.forEach(function(a,b){var c="\\[\\[_t_"+b+"\\]\\]",d=new RegExp(c,"g");o=o.replace(d,a),j=j.replace(d,a)})})):b.Deferred().resolve().promise()}).then(function(){i.resolve(o.trim(),j)},function(a){i.reject(a)})}),i.promise()},p=function(a,d){var e=b.Deferred(),f=a.split("/"),i=f.shift(),j=f.shift(),k=g.theme+"/"+a;if(k in m)return e.resolve(m[k]),e.promise();var l=h.get("core_template/"+k);if(l)return e.resolve(l),m[k]=l,e.promise();if(k in n)return n[k].promise();n[k]=e;var o=c.call([{methodname:"core_output_load_template",args:{component:i,template:j,themename:g.theme}}],d,!1);return o[0].done(function(a){h.set("core_template/"+k,a),m[k]=a,e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},q=function(a){if(""!==a.trim()){var c=b("<script>").attr("type","text/javascript").html(a);b("head").append(c)}M.util.js_pending("core-autoinitialise"),require(["core/autoinitialise"],function(a){a.scan().then(function(){M.util.js_complete("core-autoinitialise")})})},r=function(a,c,d,e){var f=b(a);if(f.length){var g=b(c);e?(f.empty(),f.append(g)):f.replaceWith(g),q(d),i.notifyFilterContentUpdated(g)}},s=function(a,c,d,e){var g={};g.classes=d||"",g=b.extend(g,e),Boolean(c)&&("[object Object]"===c.toString()?g=b.extend(g,c):g.alt=c);var h=b.Deferred();return j.getFlexTemplateData(a).done(function(a){"undefined"==typeof a.data&&(a.data={}),a.data.customdata=g,"undefined"==typeof a.data.customdata.title&&"undefined"!=typeof a.data.customdata.alt&&(a.data.customdata.title=a.data.customdata.alt),v.render(a.template,a.data).done(function(a){h.resolve(a)})}).fail(function(){var b=a.split("|");1===b.length&&b.unshift("core");var c=f.imageUrl(b[1],b[0]),d=[{name:"src",value:c},{name:"alt",value:g.alt},{name:"title",value:g.alt},{name:"class",value:"smallicon "+g.classes}];delete g.alt,delete g.classes;for(var e in g)d.push({name:e,value:g[e]});v.render("core/pix_icon",{attributes:d}).done(h.resolve)}),h.promise()},t=function(a,c,d){var e=b(a);e.length&&(e.prepend(c),q(d),i.notifyFilterContentUpdated(e))},u=function(a,c,d){var e=b(a);e.length&&(e.append(c),q(d),i.notifyFilterContentUpdated(e))},v={render:function(a,c,d){var e=b.Deferred(),f=b.extend({},c),g=p(a,!0);return g.done(function(a){var b=o(a,f);b.done(function(a,b){e.resolve(a,b)}).fail(function(a){e.reject(a)})}).fail(function(a){e.reject(a)}),e},runTemplateJS:q,replaceNodeContents:function(a,b,c){return r(a,b,c,!0)},replaceNode:function(a,b,c){return r(a,b,c,!1)},prependNodeContents:function(a,b,c){t(a,b,c)},appendNodeContents:function(a,b,c){u(a,b,c)},renderIcon:s};return v});