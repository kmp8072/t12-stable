define(["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/event","core/flex_icon","core/yui","core/log"],function(a,b,c,d,e,f,g,h,i,j,k,l){String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return b=b||0,this.substr(b,a.length)===a});var m={},n=function(c,f,h){var i=b.Deferred(),j=[],k=[],l=[],m="",n=[],q=!0,r=!0,t=function(a){var b="",c=p(a);return c.done(function(a){b=a}).fail(e.exception),""===b&&(l.push(c),q=!1),b},u=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim()),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim()),""!==f&&(f=b(f,this)),0===f.indexOf("{")&&0!==f.indexOf("{{")&&(f=JSON.parse(f));var g=n.length;return n.push({key:d,component:e,param:f}),"[[_s"+g+"]]"},v=function(a,b){var c="",d="",e={},f=a.split(",").map(function(a){return a.trim()});f.length>0&&(c=f.shift().trim()),f.length>0&&(d=f.join(",").trim()),c.indexOf("{{")!==-1&&(c=b(c,this)),""!==d&&(d.indexOf("{{")!==-1&&(d=b(d,this)),e=JSON.parse(d));var g="",h="",i=k.length;return"undefined"!=typeof e.alt&&(g=e.alt),e.classes&&(h=e.classes),k.push(s(c,g,h)),"<_p"+i+">"},w=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim()),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim());var g=e+"|"+d+',{"alt":"'+f+'"}';return v.apply(this,[g,b])},x=function(a,b){return j.push(b(a,this)),""},y=function(a,b){var c=b(a.trim(),this);return c=c.replace('"','\\"').replace(/([\{\}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>"),'"'+c+'"'};f.str=function(){return u},f.pix=function(){return w},f.flex_icon=function(){return v},f.js=function(){return x},f.quote=function(){return y},f.globals={config:g};var z=b.Deferred(),A=function(){b.when.apply(b,l).done(function(){if(q&&!r)z.resolve();else{r=!1,j=[],k=[],l=[],m="",n=[],q=!0;try{m=a.render(c,f,t),A()}catch(b){i.reject(b)}}})};return A(),z.done(function(){for(var a=0;a<k.length;a++)k[a].done(function(a){return function(b,c){j.push(c),m=m.replace("<_p"+a+">",b)}}(a));b.when.apply(b,k).then(function(){var a=b.Deferred();return j=j.join(";\n"),n.length>0?d.get_strings(n).done(function(b){m=o(m,b),j=o(j,b),i.resolve(m,getJS(b)),a.resolve()}):a.resolve(),a}).then(function(){i.resolve(m.trim(),j)},function(a){i.reject(a)})}),i.promise()},o=function(a,b){var c,d,e,f,g,h,i=/{{_s\d+}}/;do{for(c="",d=a.search(i);d>-1;){c+=a.substring(0,d),a=a.substr(d),e="",f=4,g=a.substr(f,1);do e+=g,f++,g=a.substr(f,1);while("}"!=g);h=b[parseInt(e,10)],"undefined"==typeof h&&(l.debug("Could not find string for pattern {{_s"+e+"}}."),h=""),c+=h,a=a.substr(6+e.length),d=a.search(i)}a=c+a,d=a.search(i)}while(d>-1);return a},p=function(a,d){var e=b.Deferred(),f=a.split("/"),i=f.shift(),j=f.shift(),k=g.theme+"/"+a;if(k in m)return e.resolve(m[k]),e.promise();var l=h.get("core_template/"+k);if(l)return e.resolve(l),m[k]=l,e.promise();var n=c.call([{methodname:"core_output_load_template",args:{component:i,template:j,themename:g.theme}}],d,!1);return n[0].done(function(a){h.set("core_template/"+k,a),m[k]=a,e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},q=function(a){if(""!==a.trim()){var c=b("<script>").attr("type","text/javascript").html(a);b("head").append(c)}},r=function(a,c,d,e){var f=b(a);if(f.length){var g=b(c),h=null;e?(h=new k.NodeList(f.children().get()),h.destroy(!0),f.empty(),f.append(g)):(h=new k.NodeList(f.get()),h.destroy(!0),f.replaceWith(g)),q(d),i.notifyFilterContentUpdated(g)}},s=function(a,c,d,e){var g={};g.classes=d||"",g=b.extend(g,e),Boolean(c)&&("[object Object]"===c.toString()?g=b.extend(g,c):g.alt=c);var h=b.Deferred();return j.getFlexTemplateData(a).done(function(a){"undefined"==typeof a.data&&(a.data={}),a.data.customdata=g,t.render(a.template,a.data).done(function(a){h.resolve(a)})}).fail(function(){var b=a.split("|");1===b.length&&b.unshift("core");var c=f.imageUrl(b[1],b[0]),d=[{name:"src",value:c},{name:"alt",value:g.alt},{name:"title",value:g.alt},{name:"class",value:"smallicon "+g.classes}];t.render("core/pix_icon",{attributes:d}).done(h.resolve)}),h.promise()},t={render:function(a,c,d){var e=b.Deferred(),f=b.extend({},c),g=p(a,!0);return g.done(function(a){var b=n(a,f);b.done(function(a,b){e.resolve(a,b)}).fail(function(a){e.reject(a)})}).fail(function(a){e.reject(a)}),e},runTemplateJS:q,replaceNodeContents:function(a,b,c){return r(a,b,c,!0)},replaceNode:function(a,b,c){return r(a,b,c,!1)},renderIcon:s};return t});