define(["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/event","core/flex_icon"],function(a,b,c,d,e,f,g,h,i,j){var k={},l=function(a){var b="";return n(a,!1).done(function(a){b=a}).fail(e.exception),b},m=function(c,e,f){var h=b.Deferred(),i=[],j=[],k="",m=[],n=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim()),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim()),""!==f&&(f=b(f,this)),0===f.indexOf("{")&&0!==f.indexOf("{{")&&(f=JSON.parse(f));var g=m.length;return m.push({key:d,component:e,param:f}),"{{_s"+g+"}}"},o=function(a,b){var c="",d="",e={},f=a.split(",").map(function(a){return a.trim()});f.length>0&&(c=f.shift().trim()),f.length>0&&(d=f.join(",").trim()),-1!==c.indexOf("{{")&&(c=b(c,this)),""!==d&&(-1!==d.indexOf("{{")&&(d=b(d,this)),e=JSON.parse(d));var g="",h="",i=j.length;return"undefined"!=typeof e.alt&&(g=e.alt),e.classes&&(h=e.classes),j.push(q(c,g,h)),"{{_f"+i+"}}"},p=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim()),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim());var g=e+"|"+d+',{"alt":"'+f+'"}';return o.apply(this,[g,b])},r=function(a,b){return i.push(b(a,this)),""},s=function(a,b){var c=b(a.trim(),this);return c=c.replace('"','\\"').replace(/([\{\}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>"),'"'+c+'"'};e.str=function(){return n},e.pix=function(){return p},e.flex_icon=function(){return o},e.js=function(){return r},e.quote=function(){return s},e.globals={config:g};var t=[];try{k=a.render(c,e,l)}catch(u){h.reject(u)}for(var v=0;v<j.length;v++)j[v].done(function(a){return function(b){k=k.replace("{{_f"+a+"}}",b)}}(v));if(t.push(b.when.apply(b,j)),m.length>0){var w=d.get_strings(m);t.push(w),w.done(function(a){var b;for(b=0;b<a.length;b++)k=k.replace("{{_s"+b+"}}",a[b])})}return t.length>0?(i=i.join(";\n"),b.when.apply(b,t).done(function(){h.resolve(k.trim(),i)}).fail(function(a){h.reject(a)})):h.resolve(k.trim(),i),h.promise()},n=function(a,d){var e=b.Deferred(),f=a.split("/"),i=f.shift(),j=f.shift(),l=g.theme+"/"+a;if(l in k)return e.resolve(k[l]),e.promise();var m=h.get("core_template/"+l);if(m)return e.resolve(m),k[l]=m,e.promise();var n=c.call([{methodname:"core_output_load_template",args:{component:i,template:j,themename:g.theme}}],d,!1);return n[0].done(function(a){h.set("core_template/"+l,a),k[l]=a,e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},o=function(a){if(""!==a.trim()){var c=b("<script>").attr("type","text/javascript").html(a);b("head").append(c)}},p=function(a,c,d,e){var f=b(a);if(f.length){var g=b(c);e?(f.empty(),f.append(g)):f.replaceWith(g),o(d),i.notifyFilterContentUpdated(g)}},q=function(a,c,d){var e=b.Deferred();return j.getFlexTemplateData(a).done(function(a){void 0===a.data?a.data={}:a.data.customdata={alt:c},void 0!==d&&""!==d&&(a.data.customdata.classes=d),r.render(a.template,a.data).done(function(a){e.resolve(a)})}).fail(function(){var b=a.split("|");1===b.length&&b.unshift("core");var g=f.imageUrl(b[1],b[0]),h=[{name:"src",value:g},{name:"alt",value:c},{name:"class",value:"smallicon "+d}];r.render("core/pix_icon",{attributes:h}).done(e.resolve)}),e.promise()},r={render:function(a,c,d){var e=b.Deferred(),f=n(a,!0);return f.done(function(a){var b=m(a,c);b.done(function(a,b){e.resolve(a,b)}).fail(function(a){e.reject(a)})}).fail(function(a){e.reject(a)}),e},runTemplateJS:o,replaceNodeContents:function(a,b,c){return p(a,b,c,!0)},replaceNode:function(a,b,c){return p(a,b,c,!1)},renderIcon:q};return r});