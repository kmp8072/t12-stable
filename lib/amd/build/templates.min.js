define(["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/event"],function(a,b,c,d,e,f,g,h,i){var j={},k={},l=[],m=[],n=1,o=function(a,b){return"undefined"!=typeof b&&b&&""!=b&&"moodle"!==b&&"core"!==b||(b="core"),b+"-"+a},p=function(b,c){var d,e=b.split(","),h="",i="",k="";e.length>0&&(h=e.shift().trim()),e.length>0&&(i=e.shift().trim()),e.length>0&&(k=e.join(",").trim());var l=o(h,i),m=r(l);if(m===!0)return v(l,w);var n=f.imageUrl(h,i),p={attributes:[{name:"src",value:n},{name:"alt",value:c(k)},{name:"class",value:"smallicon"}]},q=j[g.theme+"/core/pix_icon"];return d=a.render(q,p,w),d.trim()},q=function(a,b){if("undefined"!=typeof b.map[a]&&"undefined"!=typeof b.map[a].template)return b.map[a].template;if("undefined"!=typeof b.defaults&&"undefined"!=typeof b.defaults.template)return b.defaults.template;var c=new Error('core/templates: Template not defined for icon "'+a+'"');e.exception(c)},r=function(a){return s(a)===!1?!1:t(a)===!1?!1:!0},s=function(a){return null!==a.match(/^[a-zA-Z]+(_[a-zA-Z]+)*-(\w+\/)*\w+$/)},t=function(a){E(!1).done(function(b){return"undefined"!=typeof q(a,b)}).fail(e.exception)},u=function(a,c){var d={};return"undefined"!=typeof c.defaults&&"undefined"!=typeof c.defaults.data&&b.extend(d,c.defaults.data),"undefined"!=typeof c.map[a]&&"undefined"!=typeof c.map[a].data&&b.extend(d,c.map[a].data),d},v=function(c,d){var f=c.split(",").map(function(a){return a.trim()}),g=f[0],h={};"undefined"!=typeof f[1]&&(h=JSON.parse(f[1]));var i="";return E(!1).done(function(c){var f=q(g,c),j=b.extend(u(g,c),{customdata:h});D(f,!1).done(function(b){i=a.render(b,j,d)}).fail(e.exception)}).fail(e.exception),i.trim()},w=function(a){var b="";return D(a,!1).done(function(a){b=a}).fail(e.exception),b},x=function(a,b){return m.push(b(a,this)),""},y=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim()),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim()),""!==f&&(f=b(f,this)),0===f.indexOf("{")&&0!==f.indexOf("{{")&&(f=JSON.parse(f));var g=l.length;return l.push({key:d,component:e,param:f}),"{{_s"+g+"}}"},z=function(a,b){var c=b(a.trim(),this);return c=c.replace('"','\\"').replace(/([\{\}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>"),'"'+c+'"'},A=function(a,b){l=[],m=[],a.uniqid=n++,a.str=function(){return y},a.pix=function(){return p},a.flex_icon=function(){return v},a.js=function(){return x},a.quote=function(){return z},a.globals={config:g},a.currentTheme=g.theme},B=function(a){var b="";m.length>0&&(b=m.join(";\n"));var c=0;for(c=0;c<a.length;c++)b=b.replace("{{_s"+c+"}}",a[c]);return b},C=function(c,e,f){var h=b.Deferred();f=g.theme;var i=D("core/pix_icon",!0);return i.done(function(){A(e,f);var b="";try{b=a.render(c,e,w)}catch(g){h.reject(g)}l.length>0?d.get_strings(l).done(function(a){var c;for(c=0;c<a.length;c++)b=b.replace("{{_s"+c+"}}",a[c]);h.resolve(b.trim(),B(a))}).fail(function(a){h.reject(a)}):h.resolve(b.trim(),B([]))}).fail(function(a){h.reject(a)}),h.promise()},D=function(a,d){var e=b.Deferred(),f=a.split("/"),i=f.shift(),k=f.shift(),l=g.theme+"/"+a;if(l in j)return e.resolve(j[l]),e.promise();var m=h.get("core_template/"+l);if(m)return e.resolve(m),j[l]=m,e.promise();var n=c.call([{methodname:"core_output_load_template",args:{component:i,template:k,themename:g.theme}}],d,!1);return n[0].done(function(a){h.set("core_template/"+l,a),j[l]=a,e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},E=function(a){var d=b.Deferred(),e=g.theme;if(e in k)return d.resolve(k[e]),d.promise();var f=JSON.parse(h.get("core_flex_icon/"+e));if(f)return d.resolve(f),k[e]=f,d.promise();var i=c.call([{methodname:"core_output_load_flex_icons_cache",args:{themename:g.theme}}],a,!1);return i[0].done(function(a){h.set("core_flex_icon/"+e,JSON.stringify(a)),k[e]=a,d.resolve(a)}).fail(function(a){d.reject(a)}),d.promise()},F=function(a){if(""!==a.trim()){var c=b("<script>").attr("type","text/javascript").html(a);b("head").append(c)}},G=function(a,c,d,e){var f=b(a);if(f.length){var g=b(c);e?(f.empty(),f.append(g)):f.replaceWith(g),F(d),i.notifyFilterContentUpdated(g)}};return{render:function(a,c,d){var e=b.Deferred();d=g.theme;var f=D(a,!0);return f.done(function(a){var b=C(a,c,d);b.done(function(a,b){e.resolve(a,b)}).fail(function(a){e.reject(a)})}).fail(function(a){e.reject(a)}),e.promise()},runTemplateJS:F,replaceNodeContents:function(a,b,c){return G(a,b,c,!0)},replaceNode:function(a,b,c){return G(a,b,c,!1)},replacePix:function(a,b,c,d){var e=b+","+c+","+d,f=p(e,function(a){return a});return G(a,f,"",!1)},renderFlexIcon:function(a,c,d){var e=this,f=b.Deferred();return E(!0).done(function(g){var h={};b.extend(h,g.defaults,g.map[a]),void 0===h.data?h.data={}:h.data.customdata={alt:c},void 0!==d&&""!==d&&(h.data.customdata.classes=d),e.render(h.template,h.data).done(function(a){f.resolve(a)})}),f.promise()}}});