define(["jquery","core/url","core/templates","core/notification","core/str","core/ajax","tool_lp/dragdrop-reorder","tool_lp/tree","tool_lp/dialogue","tool_lp/menubar","tool_lp/competencypicker"],function(a,b,c,d,e,f,g,h,i,j,k){var l,m,n,o=null,p=null,q=null,r=function(){var c=a('[data-region="competencyactions"]').data("competency"),d={competencyframeworkid:o.getCompetencyFrameworkId(),pagecontextid:l};null!==c&&(d.parentid=c.id);var e=a.param(d);window.location=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+e)},s=function(){if("undefined"==typeof q&&(q=0),q!=p){var b=a('[data-region="filtercompetencies"]').data("frameworkid"),c=f.call([{methodname:"tool_lp_set_parent_competency",args:{competencyid:p,parentid:q}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(x).fail(d.exception)}},t=function(b){new h("[data-enhance=movetree]",function(b){q=a(b).data("id")});var c=a(b.getContent());c.on("click",'[data-action="move"]',function(){b.close(),s()}),c.on("click",'[data-action="cancel"]',function(){b.close()})},u=function(a,b){var c;for(c=0;c<b.length;c++)b[c].parentid==a.id&&(a.haschildren=!0,b[c].children=[],b[c].haschildren=!1,a.children[a.children.length]=b[c],u(b[c],b))},v=function(){var b=a('[data-region="competencyactions"]').data("competency");p=b.id;var g=f.call([{methodname:"tool_lp_search_competencies",args:{competencyframeworkid:b.competencyframeworkid,context:{contextid:l},searchtext:""}},{methodname:"tool_lp_read_competency_framework",args:{id:b.competencyframeworkid}}]);a.when.apply(null,g).done(function(a,f){var g,h=[];for(g=0;g<a.length;g++){var j=a[g];"0"==j.parentid&&(j.children=[],j.haschildren=0,h[h.length]=j,u(j,a))}e.get_strings([{key:"movecompetency",component:"tool_lp",param:b.shortname},{key:"move",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(a){var b={framework:f,competencies:h};c.render("tool_lp/competencies_move_tree",b).done(function(b){new i(a[0],b,t)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},w=function(){var c=a('[data-region="competencyactions"]').data("competency"),d={competencyframeworkid:o.getCompetencyFrameworkId(),id:c.id,parentid:c.parentid,pagecontextid:l},e=a.param(d);window.location=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+e)},x=function(b){c.render("tool_lp/manage_competencies_page",b).done(function(b,d){a('[data-region="managecompetencies"]').replaceWith(b),c.runTemplateJS(d)}).fail(d.exception)},y=function(b){b.preventDefault();var c=a('[data-region="filtercompetencies"]').data("frameworkid"),e=f.call([{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:c,search:a('[data-region="filtercompetencies"] input').val()}}]);e[0].done(x).fail(d.exception)},z=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_move_up_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(x).fail(d.exception)},A=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_move_down_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(x).fail(d.exception)},B=function(){var g=a('[data-region="competencyactions"]').data("competency"),h=f.call([{methodname:"tool_lp_list_courses_using_competency",args:{id:g.id}}]);h[0].done(function(a){var f={courseviewurl:b.relativeUrl("/course/view.php"),courses:a};c.render("tool_lp/linked_courses_summary",f).done(function(a){e.get_string("linkedcourses","tool_lp").done(function(b){new i(b,a,t)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},C=function(){n=a('[data-region="competencyactions"]').data("competency"),m||(m=new k(l,n.competencyframeworkid),m.on("save",function(b,e){var g=e.competencyId,h=f.call([{methodname:"tool_lp_add_related_competency",args:{competencyid:g,relatedcompetencyid:n.id}},{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:n.id}}]);h[1].then(function(b){return c.render("tool_lp/related_competencies",b).done(function(b,d){a('[data-region="relatedcompetencies"]').replaceWith(b),c.runTemplateJS(d),L()})},d.exception)})),m.setDisallowedCompetencyIDs([n.id]),m.display()},D=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_delete_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(x).fail(d.exception)},E=function(){var b=a('[data-region="competencyactions"]').data("competency");delete b.showdeleterelatedaction,delete b.showrelatedcompetencies,c.render("tool_lp/competency_summary",b).done(function(a){e.get_strings([{key:"confirm",component:"moodle"},{key:"deletecompetency",component:"tool_lp",param:a},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],D)}).fail(d.exception)}).fail(d.exception)},F=function(b){b.originalEvent.dataTransfer.setData("text",a(b.target).data("id"))},G=function(a){a.originalEvent.dataTransfer.dropEffect="move",a.preventDefault()},H=function(b){b.preventDefault(),a(this).addClass("currentdragtarget")},I=function(b){b.preventDefault(),a(this).removeClass("currentdragtarget")},J=function(b){b.preventDefault(),p=b.originalEvent.dataTransfer.getData("text"),q=a(b.target).data("id"),a(this).removeClass("currentdragtarget"),s()},K=function(b){b.preventDefault();var e=this.id.substr(11),g=a('[data-region="competencyactions"]').data("competency"),h=f.call([{methodname:"tool_lp_remove_related_competency",args:{relatedcompetencyid:e,competencyid:g.id}},{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:g.id}}]);h[1].done(function(b){c.render("tool_lp/related_competencies",b).done(function(b){a('[data-region="relatedcompetencies"]').replaceWith(b),L()}.bind(this)).fail(d.exception)}.bind(this)).fail(d.exception)},L=function(){a('[data-action="deleterelation"]').on("click",K),o.reloadCompetencies()};return{init:function(b,c){o=b,l=c,a('[data-region="competencyactions"] [data-action="add"]').on("click",r),j.enhance(".competencyactionsmenu",{'[data-action="edit"]':w,'[data-action="delete"]':E,'[data-action="move"]':v,'[data-action="moveup"]':z,'[data-action="movedown"]':A,'[data-action="linkedcourses"]':B,'[data-action="relatedcompetencies"]':C.bind(this)}),a('[data-region="competencyactionsmenu"]').hide(),a('[data-region="filtercompetencies"]').on("submit",y),a('[data-region="managecompetencies"] li').on("dragstart",F),a('[data-region="managecompetencies"] li').on("dragover",G),a('[data-region="managecompetencies"] li').on("dragenter",H),a('[data-region="managecompetencies"] li').on("dragleave",I),a('[data-region="managecompetencies"] li').on("drop",J)},selectionChanged:function(b){var e=a(b).data("id");if(j.closeAll(),"undefined"==typeof e)a('[data-region="competencyinfo"]').html(b.clone().children().remove().end().text()),a('[data-region="competencyactions"]').data("competency",null),a('[data-region="competencyactionsmenu"]').hide(),a('[data-region="competencyactions"] [data-action="add"]').removeAttr("disabled");else{var f=o.getCompetency(e);f.showdeleterelatedaction=!0,f.showrelatedcompetencies=!0,a('[data-region="competencyactionsmenu"]').show(),c.render("tool_lp/competency_summary",f).done(function(b){a('[data-region="competencyinfo"]').html(b),a('[data-action="deleterelation"]').on("click",K)}).fail(d.exception),a('[data-region="competencyactions"]').data("competency",f),a('[data-region="competencyactions"] [data-action="add"]').removeAttr("disabled")}}}});