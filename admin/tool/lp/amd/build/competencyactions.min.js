define(["jquery","core/url","core/templates","core/notification","core/str","core/ajax","tool_lp/dragdrop-reorder","tool_lp/tree","tool_lp/dialogue","tool_lp/menubar","tool_lp/competencypicker","tool_lp/competency_outcomes","tool_lp/competencyruleconfig"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n,o,p,q,r,s,t=null,u=null,v=null,w=function(){var c=a('[data-region="competencyactions"]').data("competency"),d={competencyframeworkid:t.getCompetencyFrameworkId(),pagecontextid:n};null!==c&&(d.parentid=c.id);var e=a.param(d);window.location=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+e)},x=function(){if("undefined"==typeof v&&(v=0),v!=u){var b=a('[data-region="filtercompetencies"]').data("frameworkid"),c=f.call([{methodname:"tool_lp_set_parent_competency",args:{competencyid:u,parentid:v}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(C).fail(d.exception)}},y=function(b){var c=a(b.getContent()),d=c.find("[data-enhance=movetree]"),e=new h(d,(!1));e.on("selectionchanged",function(b,c){var d=c.selected;v=a(d).data("id")}),d.show(),c.on("click",'[data-action="move"]',function(){b.close(),x()}),c.on("click",'[data-action="cancel"]',function(){b.close()})},z=function(a,b){var c;for(c=0;c<b.length;c++)b[c].parentid==a.id&&(a.haschildren=!0,b[c].children=[],b[c].haschildren=!1,a.children[a.children.length]=b[c],z(b[c],b))},A=function(){var b=a('[data-region="competencyactions"]').data("competency");u=b.id;var g=f.call([{methodname:"tool_lp_search_competencies",args:{competencyframeworkid:b.competencyframeworkid,searchtext:""}},{methodname:"tool_lp_read_competency_framework",args:{id:b.competencyframeworkid}}]);a.when.apply(null,g).done(function(a,f){var g,h=[];for(g=0;g<a.length;g++){var j=a[g];"0"==j.parentid&&(j.children=[],j.haschildren=0,h[h.length]=j,z(j,a))}e.get_strings([{key:"movecompetency",component:"tool_lp",param:b.shortname},{key:"move",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(a){var b={framework:f,competencies:h};c.render("tool_lp/competencies_move_tree",b).done(function(b){new i(a[0],b,y)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},B=function(){var c=a('[data-region="competencyactions"]').data("competency"),d={competencyframeworkid:t.getCompetencyFrameworkId(),id:c.id,parentid:c.parentid,pagecontextid:n},e=a.param(d);window.location=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+e)},C=function(b){c.render("tool_lp/manage_competencies_page",b).done(function(b,d){a('[data-region="managecompetencies"]').replaceWith(b),c.runTemplateJS(d)}).fail(d.exception)},D=function(b){b.preventDefault();var c=a('[data-region="filtercompetencies"]').data("frameworkid"),e=f.call([{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:c,search:a('[data-region="filtercompetencies"] input').val()}}]);e[0].done(C).fail(d.exception)},E=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_move_up_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(C).fail(d.exception)},F=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_move_down_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(C).fail(d.exception)},G=function(){var g=a('[data-region="competencyactions"]').data("competency"),h=f.call([{methodname:"tool_lp_list_courses_using_competency",args:{id:g.id}}]);h[0].done(function(a){var f={courseviewurl:b.relativeUrl("/course/view.php"),courses:a};c.render("tool_lp/linked_courses_summary",f).done(function(a){e.get_string("linkedcourses","tool_lp").done(function(b){new i(b,a,y)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},H=function(){q=a('[data-region="competencyactions"]').data("competency"),o||(o=new k(n,q.competencyframeworkid),o.on("save",function(b,e){var g=e.competencyIds,h=[];a.each(g,function(a,b){h.push({methodname:"tool_lp_add_related_competency",args:{competencyid:b,relatedcompetencyid:q.id}})}),h.push({methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:q.id}});var i=f.call(h);i[h.length-1].then(function(b){return c.render("tool_lp/related_competencies",b).done(function(b,d){a('[data-region="relatedcompetencies"]').replaceWith(b),c.runTemplateJS(d),S()})},d.exception)})),o.setDisallowedCompetencyIDs([q.id]),o.display()},I=function(b){b.preventDefault(),q=a('[data-region="competencyactions"]').data("competency"),p.setTargetCompetencyId(q.id),p.display()},J=function(a,b){var c={id:q.id,shortname:q.shortname,idnumber:q.idnumber,description:q.description,descriptionformat:q.descriptionformat,visible:q.visible,ruletype:b.ruletype,ruleoutcome:b.ruleoutcome,ruleconfig:b.ruleconfig},e=f.call([{methodname:"tool_lp_update_competency",args:{competency:c}}]);e[0].then(function(a){a&&(q.ruletype=b.ruletype,q.ruleoutcome=b.ruleoutcome,q.ruleconfig=b.ruleconfig,V(q))},d.exception)},K=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_delete_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(C).fail(d.exception)},L=function(){var b=a('[data-region="competencyactions"]').data("competency");delete b.showdeleterelatedaction,delete b.showrelatedcompetencies,delete b.showrule,c.render("tool_lp/competency_summary",b).done(function(a){e.get_strings([{key:"confirm",component:"moodle"},{key:"deletecompetency",component:"tool_lp",param:a},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],K)}).fail(d.exception)}).fail(d.exception)},M=function(b){b.originalEvent.dataTransfer.setData("text",a(b.target).parent().data("id"))},N=function(a){a.originalEvent.dataTransfer.dropEffect="move",a.preventDefault()},O=function(b){b.preventDefault(),a(this).addClass("currentdragtarget")},P=function(b){b.preventDefault(),a(this).removeClass("currentdragtarget")},Q=function(b){b.preventDefault(),u=b.originalEvent.dataTransfer.getData("text"),v=a(b.target).parent().data("id"),a(this).removeClass("currentdragtarget"),x()},R=function(b){b.preventDefault();var e=this.id.substr(11),g=a('[data-region="competencyactions"]').data("competency"),h=f.call([{methodname:"tool_lp_remove_related_competency",args:{relatedcompetencyid:e,competencyid:g.id}},{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:g.id}}]);h[1].done(function(b){c.render("tool_lp/related_competencies",b).done(function(b){a('[data-region="relatedcompetencies"]').replaceWith(b),S()}.bind(this)).fail(d.exception)}.bind(this)).fail(d.exception)},S=function(){a('[data-action="deleterelation"]').on("click",R)},T=function(a){return"undefined"!=typeof r[a+1]},U=function(a){var b=r[a];return b||(b="competency"),b},V=function(b){var e=a.Deferred().resolve().promise(),g=a.extend({},b);g.showdeleterelatedaction=!0,g.showrelatedcompetencies=!0,g.showrule=!1,b.ruleoutcome!=l.NONE&&(e=l.getString(b.ruleoutcome).then(function(c){var d;return a.each(s,function(a,c){c.type==b.ruletype&&(d=c.name)}),[c,d]})),e.then(function(a){"undefined"!=typeof a&&(g.showrule=!0,g.rule={outcome:a[0],type:a[1]})}).then(function(){return c.render("tool_lp/competency_summary",g).then(function(b){a('[data-region="competencyinfo"]').html(b),a('[data-action="deleterelation"]').on("click",R)})}).then(function(){return c.render("tool_lp/loading",{})}).then(function(a,b){c.replaceNodeContents('[data-region="relatedcompetencies"]',a,b)}).done(function(){f.call([{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:b.id},done:function(b){return c.render("tool_lp/related_competencies",b).done(function(b,d){a('[data-region="relatedcompetencies"]').replaceWith(b),c.runTemplateJS(d),S()})}}])}).fail(d.exception)},W=function(a){return e.get_string("taxonomy_add_"+U(a),"tool_lp")},X=function(a){return e.get_string("taxonomy_selected_"+U(a),"tool_lp")},Y=function(b,c){var d=c.selected,e=a(d).data("id"),f=a('[data-region="competencyactions"] [data-action="add"]'),g=a('[data-region="competencyactionsmenu"]'),h=a('[data-region="selected-competency"]'),i=0,k=1;if(j.closeAll(),"undefined"==typeof e)a('[data-region="competencyinfo"]').html(d.clone().children().remove().end().text()),a('[data-region="competencyactions"]').data("competency",null),g.hide();else{var l=t.getCompetency(e);i=t.getCompetencyLevel(e),k=!!T(i)&&i+1,g.show(),a('[data-region="competencyactions"]').data("competency",l),V(l)}return X(i).then(function(a){h.text(a)}),k?W(k).then(function(a){f.show().find('[data-region="term"]').text(a)}):f.hide(),b.preventDefault(),!1},Z=function(a){var b=a.split(",");return b.unshift(""),delete b[0],b};return{init:function(b,c,d,e){t=b,n=c,r=Z(d),s=e,a('[data-region="competencyactions"] [data-action="add"]').on("click",w),j.enhance(".competencyactionsmenu",{'[data-action="edit"]':B,'[data-action="delete"]':L,'[data-action="move"]':A,'[data-action="moveup"]':E,'[data-action="movedown"]':F,'[data-action="linkedcourses"]':G,'[data-action="relatedcompetencies"]':H.bind(this),'[data-action="competencyrules"]':I.bind(this)}),a('[data-region="competencyactionsmenu"]').hide(),a('[data-region="competencyactions"] [data-action="add"]').hide(),a('[data-region="filtercompetencies"]').on("submit",D);var f=a('[data-region="managecompetencies"] [data-enhance="tree"]');f.on("dragstart","li>span",M).on("dragover","li>span",N).on("dragenter","li>span",O).on("dragleave","li>span",P).on("drop","li>span",Q),b.on("selectionchanged",Y),p=new m(t,s),p.on("save",J.bind(this))}}});