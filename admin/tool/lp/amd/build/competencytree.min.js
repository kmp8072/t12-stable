define(["core/ajax","core/notification","core/templates","tool_lp/tree","jquery"],function(a,b,c,d,e){var f=[],g=0,h="",i="",j=function(a,b){var c=0,d=!1;for(a.haschildren=!1,a.children=[],c=0;c<b.length;c++)d=b[c],d.parentid==a.id&&(a.haschildren=!0,a.children.push(d),j(d,b))},k=function(b){var k=e.Deferred(),l=a.call([{methodname:"tool_lp_search_competencies",args:{searchtext:b,competencyframeworkid:g,includerelated:!0}}]);return l[0].done(function(a){f=[];var b=0;for(b=0;b<a.length;b++)f[a[b].id]=a[b];var g=[],l=!1;for(b=0;b<a.length;b++)l=a[b],0===parseInt(l.parentid,10)&&(g.push(l),j(l,a));var m={shortname:h,competencies:g};c.render("tool_lp/competencies_tree_root",m).done(function(a,b){c.replaceNodeContents(e(i),e(a).html(),b),new d(i),k.resolve(f)}).fail(k.reject)}).fail(k.reject),k.promise()};return{init:function(a,c,d,e){g=a,h=c,i=e,k(d).fail(b.exception)},on:function(a,b){e(i).on(a,b)},getCompetencyFrameworkId:function(){return g},getCompetency:function(a){return f[a]},getCompetencyLevel:function(a){var b=this.getCompetency(a),c=b.path.replace(/^\/|\/$/g,"").split("/").length;return c},reloadCompetencies:function(){return k("").fail(b.exception)},listCompetencies:function(){return f}}});