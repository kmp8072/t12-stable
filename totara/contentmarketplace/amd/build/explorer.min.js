define(["jquery","core/str","core/config","core/templates","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){var g={};return g.selector=null,g.haveQueriedOrSortedAtLeastOnce=!1,g.selected=[],g.totalResults=0,g.maxSelectAll=1e4,g.maxCreateCourse=100,g.warnCreateCourse=11,g.lockId=0,g.createpagepath="",g.init=function(b){var c=this,d=a(b);this.selector=b,this.createpagepath=d.data("createpagepath"),this.marketplace=d.data("marketplace"),this.mode=d.data("mode"),"create-course"==this.mode&&a(".tcm-collection-tool",this.selector).hide(),this.category=d.data("category"),a(".tcm-sorting select",d).on("change",this,function(a){a.preventDefault(),a.data.sort()}),a(".tcm-search_query form",d).on("submit",this,function(a){a.preventDefault(),a.data.search()}),d.on("change",".tcm-search_filter input",this,function(a){a.preventDefault(),a.data.search()}),a(".tcm-load-more button",d).on("click",this,function(a){a.preventDefault(),a.data.more()}),d.on("change",".tcm-thumbnail_selection input",this,function(b){b.preventDefault(),a(b.target).is(":checked")?c.addToSelection(a(b.target).val()):c.removeFromSelection(a(b.target).val())}),d.on("click",".tcm-thumbnail_selection label, .tcm-thumbnail_selection input",function(a){a.stopPropagation()}),d.on("click",".tcm-search-thumbnail",function(b){b.preventDefault();var d=a(this).find("input").val();c.showDetails(d)}),a(".tcm-search_selection_tools",d).on("click",".tcm-create-course.tcm-tool-enabled",this,function(a){a.preventDefault(),a.data.createCourse()}),a(".tcm-add-to-collection",d).on("click",this,function(a){a.preventDefault(),a.data.addToCollection()}),a(".tcm-remove-from-collection",d).on("click",this,function(a){a.preventDefault(),a.data.removeFromCollection()}),a(".tcm-select-all",d).on("click",this,function(a){a.preventDefault(),a.data.selectAll()}),a(".tcm-deselect-all",d).on("click",this,function(a){a.preventDefault(),a.data.deselectAll()}),this.search()},g.sort=function(){this.haveQueriedOrSortedAtLeastOnce=!0,this.search()},g.search=function(){var b,e,f=a(this.selector),g=this,h=this.lock();f.addClass("tcm-is-searching"),a(".tcm-search_result_summary",f).html(""),b=a(".tcm-search_query input",f).val().trim(),e={sesskey:c.sesskey,page:0,query:b,sort:a(".tcm-sorting select",f).val(),multivaluefilters:[],singlevaluefilters:[],marketplace:this.marketplace,category:this.category,mode:this.mode},this.haveQueriedOrSortedAtLeastOnce||""===b||(this.haveQueriedOrSortedAtLeastOnce=!0,e.isfirstquerywithdefaultsort=!0),a(".tcm-search_filter").each(function(){var b,c=a(this).attr("data-filter-name");a(".totara_form_element_checkboxes_checkbox",this).length>0?(b=a("input:checked",this).map(function(){return a(this).val()}).get(),e.multivaluefilters.push(c)):a(".totara_form_element_radios_radio",this).length>0&&(b=a("input:checked",this).val(),e.singlevaluefilters.push(c)),e["filter-"+c]=b}),this.data=e,a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/search.php",data:e}).done(function(b){g.totalResults=b.total,d.render("totara_contentmarketplace/results",b).done(function(c){g.checkLock(h)&&(c=a(c),a(".tcm-thumbnail_selection input",c).each(function(){g.selected.indexOf(a(this).val())>=0&&a(this).prop("checked",!0)}),a(".tcm-results").replaceWith(c),b.more?(a(".tcm-load-more",f).removeClass("tcm-load-more-loading"),a(".tcm-load-more button",f).prop("disabled",!1),a(".tcm-load-more",f).show()):a(".tcm-load-more",f).hide(),g.initResizeHandler())}),d.render("totara_contentmarketplace/filters",b).done(function(b){g.checkLock(h)&&(a(".tcm-search_filters",f).replaceWith(b),a(".tcm-checkbox-filter").on("click",".tcm-filter-show-more",function(a){a.preventDefault(),g.showMoreFilter(a)}))}),d.render("totara_contentmarketplace/result_summary",b).done(function(b){g.checkLock(h)&&(f.removeClass("tcm-is-searching"),a(".tcm-search_result_summary",f).replaceWith(b))}),a(".tcm-sorting select",f).val(b.sort),"create-course"!==g.mode&&("add"===b.selectionmode?(a(".tcm-add-to-collection",f).show(),a(".tcm-remove-from-collection",f).hide()):"remove"===b.selectionmode&&(a(".tcm-add-to-collection",f).hide(),a(".tcm-remove-from-collection",f).show()))})},g.more=function(){var b,e=a(this.selector),f=this,g=this.lock();a(".tcm-load-more",e).addClass("tcm-load-more-loading"),a(".tcm-load-more button",e).prop("disabled",!0),b=this.data,b.page+=1,a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/search.php",data:b}).done(function(b){d.render("totara_contentmarketplace/results",b).done(function(c){f.checkLock(g)&&(c=a(c),a(".tcm-thumbnail_selection input",c).each(function(){f.selected.indexOf(a(this).val())>=0&&a(this).prop("checked",!0)}),a("> div",c).appendTo(".tcm-results"),b.more?(a(".tcm-load-more",e).removeClass("tcm-load-more-loading"),a(".tcm-load-more button",e).prop("disabled",!1),a(".tcm-load-more",e).show()):a(".tcm-load-more",e).hide(),f.initResizeHandler())})})},g.addToSelection=function(a){var b=this.selected.indexOf(a);b<0&&this.selected.push(a),this.selection()},g.removeFromSelection=function(a){var b=this.selected.indexOf(a);b>-1&&this.selected.splice(b,1),this.selection()},g.selection=function(){var c=a(this.selector);if(this.selected.length>0){var d=this,e=this.selected.length,f=1===e?"itemselected":"itemselected_plural",g=a(".tcm-search_selection_status",c);b.get_string(f,"totara_contentmarketplace",e).done(function(b){d.selected.length===e&&(g.text(b),a(".tcm-search_selection_tools",c).css("visibility","visible"))})}else a(".tcm-search_selection_tools",c).css("visibility","hidden")},g.selectAll=function(){var b=this;b.totalResults>b.maxSelectAll?b.warningTooManySelectAll():(a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/select.php",data:this.data}).done(function(c){a(".tcm-select-all").siblings(".tcm-loading").css({visibility:"hidden"}),b.selected=b.selected.concat(c.selection.filter(function(a){return b.selected.indexOf(a)<0})),a(".tcm-thumbnail_selection input").each(function(){b.selected.indexOf(a(this).val())>=0&&a(this).prop("checked",!0)}),b.selection()}),a(".tcm-select-all").siblings(".tcm-loading").css({visibility:"visible"}))},g.deselectAll=function(){this.selected=[];var b=a(this.selector);a(".tcm-thumbnail_selection input:checked",b).prop("checked",!1),this.selection()},g.createCourse=function(){this.selected.length>this.maxCreateCourse?(this.disableCreateCourse(),this.warningCreateTooManyCourses()):this.selected.length>=this.warnCreateCourse?(this.disableCreateCourse(this.selected),this.warningCreateLotsOfCourses(this.openCreateCourseForm.bind(this,this.selected))):this.openCreateCourseForm(this.selected)},g.openCreateCourseForm=function(b){var d={category:this.category,selection:b,mode:this.mode};this.disableCreateCourse(),window.location=c.wwwroot+this.createpagepath+"?"+a.param(d)},g.addToCollection=function(){var b=this,d=a(b.selector);d.addClass("tcm-is-searching"),a(".tcm-search_selection_tools",d).css("visibility","hidden"),a(".tcm-search_result_summary",d).html(""),a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/update_collection.php",data:{sesskey:c.sesskey,selection:this.selected,action:"add",marketplace:this.marketplace}}).done(function(a){b.search()}),b.selected=[]},g.removeFromCollection=function(){var b=this,d=a(b.selector);d.addClass("tcm-is-searching"),a(".tcm-search_selection_tools",d).css("visibility","hidden"),a(".tcm-search_result_summary",d).html(""),a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/update_collection.php",data:{sesskey:c.sesskey,selection:this.selected,action:"remove",marketplace:this.marketplace}}).done(function(a){b.search()}),b.selected=[]},g.showMoreFilter=function(b){var c,d;c=b.delegateTarget,d=a(".tcm-filter_checkboxes-page.hidden",c),d.first().removeClass("hidden"),1===d.length&&a(".tcm-filter-show-more",c).hide()},g.warningTooManySelectAll=function(){var a=[{key:"warningtoomanyselectall:title",component:"totara_contentmarketplace"},{key:"warningtoomanyselectall:body",component:"totara_contentmarketplace"}];b.get_strings(a).done(function(a){e.create({type:e.types.CANCEL,title:a[0],body:a[1]}).done(function(a){a.show()})})},g.warningCreateTooManyCourses=function(){var a=this,c=[{key:"warningcreatetoomanycourses:title",component:"totara_contentmarketplace"},{key:"warningcreatetoomanycourses:body",component:"totara_contentmarketplace"}];b.get_strings(c).done(function(b){e.create({type:e.types.CANCEL,title:b[0],body:b[1]}).done(function(b){var c=b.getRoot();c.on(f.hidden,a.enableCreateCourse),b.show()})})},g.warningCreateLotsOfCourses=function(a){var c=this,d=[{key:"warningcreatelotsofcourses:title",component:"totara_contentmarketplace"},{key:"warningcreatelotsofcourses:body",component:"totara_contentmarketplace",param:this.selected.length},{key:"createcourses",component:"totara_contentmarketplace",param:this.selected.length},{key:"cancel"}];b.get_strings(d).done(function(b){e.create({type:e.types.CONFIRM,title:b[0],body:b[1]},void 0,{yesstr:b[2],nostr:b[3]}).done(function(b){var d=b.getRoot();d.on(f.yes,a),d.on(f.hidden,c.enableCreateCourse),b.show()})})},g.enableCreateCourse=function(){a(".tcm-create-course").addClass("tcm-tool-enabled")},g.disableCreateCourse=function(){a(".tcm-create-course").removeClass("tcm-tool-enabled")},g.showDetails=function(b){var e=this;e.hideDetails(),a(".tcm-result").removeClass("tcm-details-target"),a("#selection-"+b).closest(".tcm-result").addClass("tcm-details-target");var f=this.data;f.id=b,a("#tcm-details-wrapper-actual").length||a(".tcm-details-wrapper").clone().insertAfter(".tcm-results").attr("id","tcm-details-wrapper-actual");var g=a("#tcm-details-wrapper-actual");if(a(".tcm-details-content").remove(),g.show(),a(".tcm-preloader").show(),e.positionDetails(),!e.isElementInViewport(g[0])){var h=g[0].getBoundingClientRect();window.scrollBy({top:h.bottom-window.innerHeight,behavior:"smooth"})}a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/fetch_details.php",data:f}).done(function(c){d.render("totara_contentmarketplace/details",c).done(function(c){b===a(".tcm-details-target").find("input").val()&&(a(".tcm-preloader").hide(),a(".tcm-details-content").remove(),a(c).insertAfter(".tcm-preloader"),a(".tcm-details-close").click(e.hideDetails),a(".tcm-create-course-button").click(function(){e.openCreateCourseForm([b])}))})})},g.positionDetails=function(){var b=a("#tcm-details-wrapper-actual"),c=a(".tcm-details-target",this.selector);if(b.length&&c.length){var d=c.offset().left+Math.round(c.width()/2);a(".tcm-details-pointer").offset({left:d});var e=c;c.hasClass("tcm-last")||(e=c.nextAll(".tcm-last:first")),b.detach().insertAfter(e)}},g.hideDetails=function(){a("#tcm-details-wrapper-actual",this.selector).remove(),a(".tcm-result").removeClass("tcm-details-target")},g.initResizeHandler=function(){var b=this;a(window).on("resize",function(){if(a(".tcm-result").length){var c=a("#tcm-details-wrapper-actual");c.length&&a("#tcm-details-wrapper-actual").hide();var d=a(".tcm-result:first",b.selector).position().left;a(".tcm-result",b.selector).removeClass("tcm-last"),a(".tcm-result").each(function(){if(a(this).position().left===d){var b=a(this).prev();b.hasClass("tcm-details-wrapper")&&(b=b.prev()),b.addClass("tcm-last")}}),a(".tcm-result:last").addClass("tcm-last"),c.length&&a("#tcm-details-wrapper-actual").show(),b.positionDetails()}}),a(window).trigger("resize")},g.isElementInViewport=function(a){var b=a.getBoundingClientRect();return b.top>=0&&b.left>=0&&b.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&b.right<=(window.innerWidth||document.documentElement.clientWidth)},g.lock=function(){return++this.lockId},g.checkLock=function(a){return this.lockId===a},g});