define([],function(){function a(){return this instanceof a?(this.activeClass="tw-selectTree__active",this.activeSelector="data-tw-selector-active",this.clearSelector="data-tw-selectorgroup-clear",this.hideClass="tw-selectTree__hidden",this.key="",this.keyboardClass="tw-selectTree__keyboard",this.repositionClass="tw-selectTree__reposition",void(this.widget="")):new a}a.prototype={constructor:a,add:function(a){var b=a.getAttribute("data-tw-selectTree-urlVal"),c=a.getAttribute("data-tw-selectTree-label"),d=a.parentNode,e=d.hasAttribute("data-tw-selectTree-default");this.removeActive(),this.closeLists(),this.setCurrentLabel(c),d.classList.add(this.activeClass),e||d.setAttribute(this.activeSelector,""),this.expandActiveLists(d),this.setEventType(b)},closeLists:function(){for(var a=this.widget.querySelectorAll("[data-tw-selectTree-list]"),b=0;b<a.length;b++)if(!a[b].classList.contains(this.hideClass)){var c=a[b].previousElementSibling,d=c.querySelector("[data-tw-selectTree-toggle]");this.toggleTreeList(a[b],d)}},events:function(){var a=this;this.widget.addEventListener("click",function(b){if(b.preventDefault(),b.target)if(b.target.closest("[data-tw-selectTree-trigger]"))a.toggleTree();else if(b.target.closest("[data-tw-selectTree-toggle]")){var c=b.target.closest("[data-tw-selectTree-toggle]"),d=c.parentNode.nextElementSibling;a.toggleTreeList(d,c)}else if(b.target.closest("[data-tw-selectTree-urlVal]")){var e=b.target.closest("[data-tw-selectTree-urlVal]");if(e.parentNode.classList.contains(a.activeClass))return;a.add(e),a.toggleTree(),a.triggerEvent("changed",{})}});var b=function(b){var c=a.widget.querySelector("[data-tw-selectTree-tree]");a.widget.contains(b.target)||c.classList.contains(a.hideClass)||a.toggleTree()};document.body.classList.contains("safari")?(document.addEventListener("click",b),document.addEventListener("touchstart",b)):this.widget.addEventListener("focusout",function(b){var c=a.widget.querySelector("[data-tw-selectTree-tree]");if(b.target&&!c.classList.contains(a.hideClass)&&(!b.relatedTarget||!b.relatedTarget.closest("[data-tw-selectTree-tree]"))){if(b.relatedTarget&&a.widget.contains(b.relatedTarget)&&b.relatedTarget.hasAttribute("data-tw-selectTree-trigger"))return;a.toggleTree()}}),this.widget.addEventListener("keydown",function(b){if(b.target){for(var c=0,d=a.widget.querySelectorAll(".tw-selectTree__list_row"),e=!1,f=0;f<d.length;++f)if(d[f]==document.activeElement.closest(".tw-selectTree__list_row")){c=f,e=!0;break}if(!e)for(var f=0;f<d.length;++f)if(d[f].classList.contains("tw-selectTree__active")){c=f;break}switch(a.widget.classList.add(a.keyboardClass),b.key){case"ArrowUp":case"Up":if(b.preventDefault(),0===c)return;for(var g=c-1,h=g;h<d.length;++h){var i=d[g].getElementsByClassName("tw-selectTree__list_row_link")[0];if(i&&0!==i.offsetHeight)return void i.focus();g--}break;case"ArrowDown":case"Down":if(b.preventDefault(),c===d.length-1)return;for(var j=c+1;j<d.length;++j){var i=d[j].getElementsByClassName("tw-selectTree__list_row_link")[0];if(i&&0!==i.offsetHeight)return void i.focus()}break;case"ArrowLeft":case"Left":b.preventDefault();var i=d[c].getElementsByClassName("tw-selectTree__list_row_icon_expand")[0];i&&i.classList.contains("tw-selectTree__hidden")&&d[c].querySelector("[data-tw-selecttree-toggle]").click();break;case"ArrowRight":case"Right":b.preventDefault();var i=d[c].getElementsByClassName("tw-selectTree__list_row_icon_expanded")[0];i&&i.classList.contains("tw-selectTree__hidden")&&d[c].querySelector("[data-tw-selecttree-toggle]").click()}}});var c=new MutationObserver(function(){"true"===a.widget.getAttribute(a.clearSelector)&&(a.setToDefault(),a.triggerEvent("changed",{}),a.widget.setAttribute(a.clearSelector,!1))});c.observe(this.widget,{attributes:!0,attributeFilter:[a.clearSelector],subtree:!1})},expandActiveLists:function(a){for(var b,c=!1;!c;)if(b=a.closest("[data-tw-selectTree-list]."+this.hideClass)){var d=b.previousElementSibling,e=d.querySelector("[data-tw-selectTree-toggle]");this.toggleTreeList(b,e)}else c=!0},preset:function(){var a=this.widget.querySelector("["+this.activeSelector+"]");if(a){var b=a.querySelector("[data-tw-selectTree-urlVal]"),c=b.getAttribute("data-tw-selectTree-urlVal");this.expandActiveLists(a),this.setEventType(c)}},removeActive:function(){var a=this.widget.querySelectorAll("[data-tw-selectTree-tree] ["+this.activeSelector+"]"),b=this.widget.querySelector("[data-tw-selectTree-default]");b.classList.remove(this.activeClass);for(var c=0;c<a.length;c++)a[c].classList.remove(this.activeClass),a[c].removeAttribute(this.activeSelector)},setCurrentLabel:function(a){var b=this.widget.querySelector("[data-tw-selectTree-current]");b.innerHTML=a},setEventType:function(a){a?this.triggerEvent("add",{key:this.key,val:a}):this.triggerEvent("remove",{key:this.key})},setKey:function(a){this.key=a},setParent:function(a){this.widget=a},setToDefault:function(){var a=this.widget.querySelector("[data-tw-selectTree-default] [data-tw-selectTree-urlVal]"),b=a.getAttribute("data-tw-selectTree-label"),c=a.getAttribute("data-tw-selectTree-urlVal"),d=a.parentNode;this.removeActive(),this.closeLists(),this.expandActiveLists(d),this.setCurrentLabel(b),d.classList.add(this.activeClass),this.setEventType(c)},toggleExpandIcons:function(a){var b=a.childNodes;b[0].classList.toggle(this.hideClass),b[1].classList.toggle(this.hideClass)},toggleTreeList:function(a,b){a.classList.toggle(this.hideClass),this.toggleExpandIcons(b);var c=a.classList.contains(this.hideClass)?"false":"true";b.setAttribute("aria-expanded",c)},toggleTree:function(){var a=this.widget.querySelector("[data-tw-selectTree-tree]"),b=this.widget.querySelector("[data-tw-selectTree-trigger]");a.classList.remove(this.repositionClass),b.classList.toggle(this.activeClass),a.classList.toggle(this.hideClass);var c=a.getBoundingClientRect().right,d=document.documentElement.clientWidth;if(d<c&&a.classList.toggle(this.repositionClass),a.classList.contains(this.hideClass))a.setAttribute("aria-hidden","true"),this.widget.classList.remove(this.keyboardClass);else{a.setAttribute("aria-hidden","false");var e=a.querySelector("["+this.activeSelector+"] [data-tw-selectTree-label]"),f=e?e:a.querySelector("[data-tw-selectTree-default]");this.expandActiveLists(f),f.focus()}},triggerEvent:function(a,b){var c=new CustomEvent("totara_core/select_tree:"+a,{bubbles:!0,detail:b});this.widget.dispatchEvent(c)}};var b=function(b){return new Promise(function(c){var d=new a;d.setParent(b),d.setKey(b.getAttribute("data-tw-selectTree-urlkey")),d.preset(),d.events(),c(d)})};return{init:b}});